org: artemsopa
app: northwind-consumer
service: northwind-consumer
frameworkVersion: '3'
useDotenv: true

plugins:
  - serverless-webpack
  - serverless-offline
  - serverless-export-env

provider:
  name: aws
  runtime: nodejs14.x
  region: eu-central-1
  stage: ${opt:stage, 'dev'}
  environment:
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_NAME: ${env:DB_NAME}
    AWS_SQS_URL: { Ref: MessagesQueue }
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "sqs:SendMessage"
        - "sqs:DeleteMessageBatch"
      Resource: 
        - Fn::GetAtt: [MessagesQueue, Arn]
    - Effect: "Allow"
      Action:
        - ec2:CreateNetworkInterface
        - ec2:DescribeNetworkInterfaces
        - ec2:DeleteNetworkInterface
      Resource:
        - "*"

custom: 
  webpack: 
    includeModules: 
      true

functions:
  consumer:
    handler: ./src/index.consumer
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - MessagesQueue
              - Arn
resources:
  Resources:
    MessagesQueue:
      Type: AWS::SQS::Queue
      Properties:
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt DeadLetterMessagesQueue.Arn
          maxReceiveCount: 3
        # Two minutes
        VisibilityTimeout: 120
    DeadLetterMessagesQueue:
      Type: AWS::SQS::Queue
      Properties:
        # Seven days
        MessageRetentionPeriod: 604800